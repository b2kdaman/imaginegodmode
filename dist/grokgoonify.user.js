// ==UserScript==
// @name         grokGoonify
// @namespace    http://tampermonkey.net/
// @version      1.4
// @description  Grok Media Post Fetcher + Downloader + Upscaler with text note management
// @author       b2kdaman
// @match        https://grok.com/imagine/post/*
// @match        https://www.grok.com/imagine/post/*
// @run-at       document-idle
// @grant        GM_download
// ==/UserScript==



(function () {
    'use strict';

(()=>{var e="4px",t="8px",s="12px",n="2px",a="8px",o="13px",l="16px",i="#1a1a1a",r="#2a2a2a",d="#3a3a3a",c="#fff",p="#b0b0b0",h="rgba(0,0,0,0.4)",u="rgba(255, 255, 255, 0.2)",m="0.2s",x="ease",g="Ready",y={elements:{container:null,pill:null,textNavPill:null,textPill:null,textInput:null,prevBtn:null,nextBtn:null,addBtn:null,removeBtn:null,details:null,status:null,upscaleInfo:null,fetchBtn:null,downloadBtn:null,upscaleBtn:null,promptBtn:null,linksWrap:null},textItems:[],currentIndex:0,currentView:"prompt",loadTextItems(){try{const e=localStorage.getItem("grok-text-items");this.textItems=e?JSON.parse(e):[""]}catch{this.textItems=[""]}this.currentIndex=0},saveTextItems(){try{localStorage.setItem("grok-text-items",JSON.stringify(this.textItems))}catch(e){console.error("Failed to save text items:",e)}},updateTextInput(){this.elements.textInput&&(this.elements.textInput.value=this.textItems[this.currentIndex]||""),this.updateNavButtons()},updateNavButtons(){this.elements.prevBtn&&(this.elements.prevBtn.disabled=0===this.currentIndex,this.elements.prevBtn.style.opacity=0===this.currentIndex?"0.3":"1"),this.elements.nextBtn&&(this.elements.nextBtn.disabled=this.currentIndex>=this.textItems.length-1,this.elements.nextBtn.style.opacity=this.currentIndex>=this.textItems.length-1?"0.3":"1"),this.elements.removeBtn&&(this.elements.removeBtn.disabled=this.textItems.length<=1,this.elements.removeBtn.style.opacity=this.textItems.length<=1?"0.3":"1")},switchView(e){this.currentView=e,this.elements.textNavPill&&this.elements.textPill&&this.elements.details&&("prompt"===e?(this.elements.textNavPill.style.display="inline-flex",this.elements.textPill.style.display="flex",this.elements.details.style.display="none"):(this.elements.textNavPill.style.display="none",this.elements.textPill.style.display="none",this.elements.details.style.display="block"))},createButton(t,n=!0){const a=document.createElement("button");return Object.assign(a.style,{display:"inline-flex",alignItems:"center",justifyContent:"center",gap:n?"6px":"0",border:"none",background:r,color:p,padding:`${e} ${s}`,borderRadius:l,cursor:"pointer",fontSize:o,fontWeight:"500",lineHeight:"1.2",outline:"none",transition:`all ${m} ${x}`,minHeight:"auto"}),a.onmouseenter=()=>{a.style.background=d,a.style.color="#d0d0d0"},a.onmouseleave=()=>{a.style.background=r,a.style.color=p},a.textContent=t,a},ensure(){if(this.elements.container)return;this.loadTextItems();const y=document.createElement("div");y.id="grok-media-fetcher",Object.assign(y.style,{position:"fixed",bottom:"72px",right:"24px",zIndex:"99999",fontSize:o,fontFamily:'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',color:c,pointerEvents:"auto"}),this.elements.container=y;const f=document.createElement("div");Object.assign(f.style,{display:"inline-flex",alignItems:"center",gap:"8px",padding:e,borderRadius:l,background:i,border:"none",boxShadow:`0 4px 12px ${h}`,marginBottom:a}),this.elements.textNavPill=f;const I=this.createButton("‚Üê",!1);I.style.padding=`${t} ${s}`,I.addEventListener("click",()=>{this.currentIndex>0&&(this.currentIndex--,this.updateTextInput())}),this.elements.prevBtn=I;const v=this.createButton("‚Üí",!1);v.style.padding=`${t} ${s}`,v.addEventListener("click",()=>{this.currentIndex<this.textItems.length-1&&(this.currentIndex++,this.updateTextInput())}),this.elements.nextBtn=v;const w=this.createButton("+",!1);w.style.padding=`${t} ${s}`,w.addEventListener("click",()=>{""!==(this.textItems[this.currentIndex]||"").trim()&&(this.textItems.push(""),this.currentIndex=this.textItems.length-1,this.updateTextInput(),this.saveTextItems())}),this.elements.addBtn=w;const T=this.createButton("√ó",!1);T.style.padding=`${t} ${s}`,T.addEventListener("click",()=>{this.textItems.length>1&&(this.textItems.splice(this.currentIndex,1),this.currentIndex=Math.min(this.currentIndex,this.textItems.length-1),this.updateTextInput(),this.saveTextItems())}),this.elements.removeBtn=T,f.appendChild(I),f.appendChild(v),f.appendChild(w),f.appendChild(T);const b=document.createElement("div");Object.assign(b.style,{display:"flex",alignItems:"stretch",gap:"6px",borderRadius:l,background:i,border:"none",boxShadow:`0 4px 12px ${h}`,marginBottom:a,padding:e}),this.elements.textPill=b;const C=document.createElement("textarea");C.rows=3,C.placeholder="Enter text...",Object.assign(C.style,{flex:"1",padding:`${t} ${s}`,border:`1px solid ${u}`,borderRadius:l,background:r,color:c,fontSize:o,fontFamily:'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',outline:"none",transition:`all ${m} ${x}`,resize:"vertical"}),C.addEventListener("input",e=>{this.textItems[this.currentIndex]=e.target.value,this.saveTextItems()}),C.addEventListener("focus",()=>{C.style.background=d,C.style.borderColor=p}),C.addEventListener("blur",()=>{C.style.background=r,C.style.borderColor=u}),this.elements.textInput=C;const k=document.createElement("div");Object.assign(k.style,{display:"flex",flexDirection:"column",gap:"4px"});const B=this.createButton("‚Üì",!1);B.title="Copy from page input",Object.assign(B.style,{padding:`${e} ${t}`,flex:"1",minHeight:"0"}),B.addEventListener("click",()=>{try{const e=document.querySelector('textarea[placeholder="Make a video"]');if(e&&e.value){this.textItems[this.currentIndex]=e.value,this.updateTextInput(),this.saveTextItems();const t=B.textContent;B.textContent="‚úì",setTimeout(()=>{B.textContent=t},1e3)}else B.textContent="‚úó",setTimeout(()=>{B.textContent="‚Üì"},1e3)}catch(e){console.error("Failed to copy from external textarea:",e)}});const U=this.createButton("‚Üë",!1);U.title="Copy to page input",Object.assign(U.style,{padding:`${e} ${t}`,flex:"1",minHeight:"0"}),U.addEventListener("click",()=>{try{const e=document.querySelector('textarea[placeholder="Make a video"]');if(e){const t=this.textItems[this.currentIndex]||"";Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value").set.call(e,t);const s=new Event("input",{bubbles:!0});e.dispatchEvent(s);const n=U.textContent;U.textContent="‚úì",setTimeout(()=>{U.textContent=n},1e3)}else U.textContent="‚úó",setTimeout(()=>{U.textContent="‚Üë"},1e3)}catch(e){console.error("Failed to copy to external textarea:",e)}});const E=this.createButton("Copy",!1);E.style.padding=`${t} ${s}`,E.style.alignSelf="stretch",E.addEventListener("click",async()=>{const e=this.textItems[this.currentIndex]||"";try{await navigator.clipboard.writeText(e);const t=E.textContent;E.textContent="Copied!",setTimeout(()=>{E.textContent=t},1500)}catch(e){console.error("Failed to copy:",e),E.textContent="Failed",setTimeout(()=>{E.textContent="Copy"},1500)}}),k.appendChild(B),k.appendChild(U),b.appendChild(C),b.appendChild(k),b.appendChild(E),this.updateTextInput();const S=document.createElement("div");Object.assign(S.style,{display:"inline-flex",alignItems:"center",gap:"8px",padding:e,borderRadius:l,background:i,border:"none",boxShadow:`0 4px 12px ${h}`}),this.elements.pill=S;const $=this.createButton("Fetch",!1);$.style.color=p,this.elements.fetchBtn=$,this.elements.upscaleBtn=this.createButton("Upscale",!1),this.elements.downloadBtn=this.createButton("Download",!1);const P=this.createButton("Prompt",!1);this.elements.promptBtn=P,S.appendChild(P),S.appendChild($),S.appendChild(this.elements.upscaleBtn),S.appendChild(this.elements.downloadBtn);const D=document.createElement("div");Object.assign(D.style,{marginTop:a,padding:`${s} 16px`,borderRadius:l,background:i,border:"none",fontSize:"12px",color:p,display:"none",maxWidth:"280px",boxShadow:`0 4px 12px ${h}`}),this.elements.details=D;const M=document.createElement("div");M.textContent=g,M.style.marginBottom=n,this.elements.status=M;const V=document.createElement("div");V.textContent="Upscaled 0 / 0 (HD 0)",this.elements.upscaleInfo=V,D.appendChild(M),D.appendChild(V);const F=document.createElement("div");Object.assign(F.style,{marginTop:a,padding:`${e} ${t}`,borderRadius:"8px",background:i,border:"none",fontSize:"11px",color:p,textAlign:"center",boxShadow:`0 4px 12px ${h}`}),F.textContent="grokGoonify 1.4 by b2kdaman",this.elements.footer=F,y.appendChild(f),y.appendChild(b),y.appendChild(D),y.appendChild(S),y.appendChild(F),document.body.appendChild(y),this.switchView("prompt")},attachHandlers(e){this.elements.container&&(this.elements.fetchBtn.addEventListener("click",e.fetch),this.elements.downloadBtn.addEventListener("click",e.download),this.elements.upscaleBtn.addEventListener("click",e.upscale),this.elements.promptBtn.addEventListener("click",()=>{this.switchView("prompt")}))},showDetails(){this.ensure(),this.switchView("status")},hideDetails(){this.ensure(),this.switchView("prompt")},setStatus(e){this.ensure(),this.elements.status.textContent=e},setUpscaleInfo(e,t,s){this.ensure(),this.elements.upscaleInfo.textContent=`Upscaled ${e} / ${t} (HD ${s})`},clearLinksWrap(){this.elements.linksWrap&&(this.elements.linksWrap.remove(),this.elements.linksWrap=null)},renderMediaInfo(e){this.clearLinksWrap();const t=document.createElement("div");if(t.className="grok-media-links",t.style.marginTop=n,e.urls.length){const s=document.createElement("div"),a=e.videosToUpscale.length+e.hdVideoCount;s.textContent=`Media: ${e.urls.length} | Videos: ${a} (HD ${e.hdVideoCount}, ${e.videosToUpscale.length} to upscale)`,s.style.marginTop=n,t.appendChild(s)}else{const e=document.createElement("div");e.textContent="No media URLs detected",t.appendChild(e)}this.elements.details.appendChild(t),this.elements.linksWrap=t}},f=()=>window.location.pathname.split("/").filter(Boolean)[2]||null,I=(e,t=0)=>e.split("?")[0].split("/").filter(Boolean).pop()||`media_${t+1}`,v=e=>e&&(e.hdMediaUrl||e.mediaUrl||e.thumbnailImageUrl||null),w=(e,t)=>e+Math.random()*(t-e),T=()=>(new Date).toLocaleTimeString(),b=()=>"function"==typeof GM_download,C={lastMediaUrls:[],lastVideoIdsToUpscale:[],lastHdVideoCount:0,upscaleTotal:0,upscaleDone:0,isUpscaling:!1,upscaleRefetchTimeout:null,upscaleTimeoutIds:[],urlWatcherInterval:null,lastKnownPostId:null,resetForNewPost(e){for(this.lastMediaUrls=[],this.lastVideoIdsToUpscale=[],this.lastHdVideoCount=0,this.upscaleTotal=0,this.upscaleDone=0,this.isUpscaling=!1,this.upscaleRefetchTimeout&&(clearTimeout(this.upscaleRefetchTimeout),this.upscaleRefetchTimeout=null);this.upscaleTimeoutIds.length;){const e=this.upscaleTimeoutIds.pop();clearTimeout(e)}}},k={start(){C.urlWatcherInterval||(C.lastKnownPostId=f(),this.resetForNewPost(C.lastKnownPostId),C.urlWatcherInterval=setInterval(()=>{const e=f();e!==C.lastKnownPostId&&(C.lastKnownPostId=e,this.resetForNewPost(e))},500))},resetForNewPost(e){C.resetForNewPost(e),y.clearLinksWrap(),y.setUpscaleInfo(0,0,0),y.hideDetails(),e?y.setStatus(g):y.setStatus("Waiting for post‚Ä¶")}},B={async fetchPostData(e){const t=await fetch("/rest/media/post/get",{method:"POST",headers:{accept:"*/*","content-type":"application/json"},body:JSON.stringify({id:e})});if(!t.ok)throw new Error(`HTTP ${t.status}`);return t.json()},async upscaleVideo(e){const t=await fetch("/rest/media/video/upscale",{method:"POST",headers:{accept:"*/*","content-type":"application/json"},body:JSON.stringify({videoId:e})});if(!t.ok)throw new Error(`Upscale HTTP ${t.status}`);const s=await t.json().catch(()=>null);return console.log("[Grok Media Fetcher] Upscale response for",e,s),s}},U={processPostData(e){const t=[],s=[];let n=0;return Array.isArray(e.childPosts)&&e.childPosts.length>0&&e.childPosts.forEach(e=>{const a=v(e);a&&t.push(a),"MEDIA_POST_TYPE_VIDEO"===e.mediaType&&(e.hdMediaUrl?n+=1:e.id&&s.push(e.id))}),{urls:Array.from(new Set(t)),videosToUpscale:Array.from(new Set(s)),hdVideoCount:n}}},E={async fetchAndRender(){y.ensure();const e=f();if(e)try{const t=await B.fetchPostData(e);window.grokPostData=t,console.log("[Grok Media Fetcher] Response:",t);const s=t.post||{};y.setStatus("‚úÖ Fetched @ "+T());const n=U.processPostData(s);C.lastMediaUrls=n.urls,C.lastVideoIdsToUpscale=n.videosToUpscale,C.lastHdVideoCount=n.hdVideoCount,y.renderMediaInfo(n),C.isUpscaling||(C.upscaleTotal=n.videosToUpscale.length,C.upscaleDone=0),y.setUpscaleInfo(C.upscaleDone,C.upscaleTotal,C.lastHdVideoCount)}catch(e){console.error("[Grok Media Fetcher] Error:",e),y.setStatus("‚ùå Error (see console)")}else y.setStatus("‚ùå Could not detect post ID")},startUpscaleRefetchLoop(){if(C.upscaleRefetchTimeout)return;const e=async()=>{if(!C.isUpscaling||C.upscaleDone>=C.upscaleTotal)return void(C.upscaleRefetchTimeout=null);try{await this.fetchAndRender()}catch(e){console.error("[Grok Media Fetcher] Upscale-refetch error:",e)}const t=w(3e3,5e3);C.upscaleRefetchTimeout=setTimeout(e,t)};e()},async processUpscaleBatch(){C.isUpscaling=!0,C.upscaleTotal=C.lastVideoIdsToUpscale.length,C.upscaleDone=0,y.setUpscaleInfo(C.upscaleDone,C.upscaleTotal,C.lastHdVideoCount),y.setStatus("üöÄ Upscaling started..."),this.startUpscaleRefetchLoop(),C.upscaleTimeoutIds.splice(0,C.upscaleTimeoutIds.length);const e=[...C.lastVideoIdsToUpscale],t=e.length;let s=0;e.forEach((e,n)=>{const a=w(1e3,2e3);s+=a;const o=setTimeout(async()=>{try{await B.upscaleVideo(e),C.upscaleDone+=1,y.setUpscaleInfo(C.upscaleDone,C.upscaleTotal,C.lastHdVideoCount)}catch(t){console.error("[Grok Media Fetcher] Upscale error for",e,t)}n===t-1&&(C.isUpscaling=!1,y.setStatus("‚úÖ Upscale batch finished, fetching results..."),setTimeout(async()=>{try{await this.fetchAndRender(),y.setStatus("‚úÖ Upscale complete with updated media")}catch(e){console.error("[Grok Media Fetcher] Final fetch error:",e),y.setStatus("‚úÖ Upscale finished (fetch failed)")}},2e3))},s);C.upscaleTimeoutIds.push(o)})}},S={fallback(e,t){const s=document.createElement("a");s.href=e,s.download=t,s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s)},withGmDownload(e,t){try{GM_download({url:e,name:t,saveAs:!1,onerror:s=>{console.error("[Grok Media Fetcher] GM_download error, fallback triggered:",s),this.fallback(e,t)}})}catch(s){console.error("[Grok Media Fetcher] GM_download threw, fallback triggered:",s),this.fallback(e,t)}},trigger(e){const t=b();e.forEach((e,s)=>{setTimeout(()=>{const n=I(e,s);t?this.withGmDownload(e,n):this.fallback(e,n)},500*s)})}},$={async fetch(){await E.fetchAndRender(),y.showDetails()},async download(){y.showDetails(),y.setStatus("üîÑ Fetching latest data..."),await E.fetchAndRender(),C.lastMediaUrls&&0!==C.lastMediaUrls.length?(y.setStatus(`‚¨á Downloading ${C.lastMediaUrls.length} item(s)...`),S.trigger(C.lastMediaUrls)):y.setStatus("‚ö†Ô∏è Nothing to download ‚Äì no media found")},async upscale(){y.showDetails(),C.isUpscaling?y.setStatus("‚è≥ Already upscaling..."):(await E.fetchAndRender(),C.lastVideoIdsToUpscale&&0!==C.lastVideoIdsToUpscale.length?await E.processUpscaleBatch():y.setStatus("‚ö†Ô∏è No videos to upscale (either none or already HD)"))}};function P(){y.ensure(),y.attachHandlers($),k.start()}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",P):P()})();
})();