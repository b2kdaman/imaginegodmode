// ==UserScript==
// @name         grokGoonify
// @namespace    http://tampermonkey.net/
// @version      1.5
// @description  Grok Media Post Fetcher + Downloader + Upscaler with text note management
// @author       b2kdaman
// @match        https://grok.com/imagine/post/*
// @match        https://www.grok.com/imagine/post/*
// @match        https://grok.com/imagine/favorites
// @match        https://www.grok.com/imagine/favorites
// @run-at       document-idle
// @grant        GM_download
// ==/UserScript==



(function () {
    'use strict';

(()=>{var e="4px",t="6px",n="4px",s="8px",i="12px",o="2px",l="8px",r="13px",a="36px",c="16px",d="#1a1a1a",p="#2a2a2a",u="#3a3a3a",h="#fff",g="#b0b0b0",m="#d0d0d0",y="rgba(0,0,0,0.4)",f="rgba(255, 255, 255, 0.2)",x="0.2s",b="ease",C="Ready",k={elements:{container:null,toggleBtn:null,contentWrapper:null,categoryPill:null,pill:null,textPill:null,textInput:null,categoryDropdown:null,addCategoryBtn:null,deleteCategoryBtn:null,categoryInput:null,saveCategoryBtn:null,cancelCategoryBtn:null,prevBtn:null,nextBtn:null,addBtn:null,removeBtn:null,playBtn:null,starRating:null,details:null,status:null,upscaleInfo:null,downloadBtn:null,upscaleBtn:null,promptBtn:null,linksWrap:null,spinBtn:null,fullscreenBtn:null},categories:{},currentCategory:"Default",currentIndex:0,currentView:"prompt",isAddingCategory:!1,isHidden:!1,lastDeleteClickTime:0,isSpinning:!1,shouldStopSpinning:!1,spinAnimationInterval:null,loadTextItems(){try{const e=localStorage.getItem("grok-text-items");if(!e)return this.categories={Default:[{text:"",rating:0}]},this.currentCategory="Default",void(this.currentIndex=0);const t=JSON.parse(e);Array.isArray(t)?(this.categories={Default:t.length>0?t:[""]},this.currentCategory="Default",this.currentIndex=0,this.saveTextItems()):(this.categories=t.categories||{Default:[""]},this.currentCategory=t.currentCategory||"Default",this.currentIndex=t.currentIndex||0,this.categories[this.currentCategory]||(this.currentCategory="Default",this.currentIndex=0)),Object.keys(this.categories).forEach(e=>{this.categories[e]=this.categories[e].map(e=>"string"==typeof e?{text:e,rating:0}:{text:e.text||"",rating:e.rating||0})})}catch(e){console.error("Failed to load text items:",e),this.categories={Default:[{text:"",rating:0}]},this.currentCategory="Default",this.currentIndex=0}},saveTextItems(){try{const e={categories:this.categories,currentCategory:this.currentCategory,currentIndex:this.currentIndex};localStorage.setItem("grok-text-items",JSON.stringify(e))}catch(e){console.error("Failed to save text items:",e)}},getCurrentPrompts(){return this.categories[this.currentCategory]||[""]},setCurrentPrompt(e,t){if(this.categories[this.currentCategory]||(this.categories[this.currentCategory]=[{text:"",rating:0}]),"string"==typeof t){const n=this.categories[this.currentCategory][e];this.categories[this.currentCategory][e]={text:t,rating:n?.rating||0}}else this.categories[this.currentCategory][e]=t},updateTextInput(){if(this.elements.textInput){const e=this.getCurrentPrompts();this.elements.textInput.value=e[this.currentIndex]?.text||""}this.updateNavButtons(),this.updateStarRating()},updateNavButtons(){const e=this.getCurrentPrompts();this.elements.prevBtn&&(this.elements.prevBtn.disabled=0===this.currentIndex,this.elements.prevBtn.style.opacity=0===this.currentIndex?"0.3":"1"),this.elements.nextBtn&&(this.elements.nextBtn.disabled=this.currentIndex>=e.length-1,this.elements.nextBtn.style.opacity=this.currentIndex>=e.length-1?"0.3":"1"),this.elements.removeBtn&&(this.elements.removeBtn.disabled=e.length<=1,this.elements.removeBtn.style.opacity=e.length<=1?"0.3":"1")},setRating(e){const t=this.getCurrentPrompts()[this.currentIndex];t&&(t.rating=e,this.updateStarRating(),this.saveTextItems())},updateStarRating(){if(!this.elements.starRating)return;const e=this.getCurrentPrompts(),t=e[this.currentIndex]?.rating||0,n=this.elements.starRating.children;for(let e=0;e<n.length;e++)e<t?(n[e].innerHTML="&#9733;",n[e].style.color="#FFD700"):(n[e].innerHTML="&#9734;",n[e].style.color="#666")},updateCategoryDropdown(){this.elements.categoryDropdown&&(this.elements.categoryDropdown.innerHTML="",Object.keys(this.categories).forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,e===this.currentCategory&&(t.selected=!0),this.elements.categoryDropdown.appendChild(t)}))},startAddCategory(){this.isAddingCategory||(this.isAddingCategory=!0,this.elements.categoryDropdown&&(this.elements.categoryDropdown.style.display="none"),this.elements.addCategoryBtn&&(this.elements.addCategoryBtn.style.display="none"),this.elements.deleteCategoryBtn&&(this.elements.deleteCategoryBtn.style.display="none"),this.elements.categoryInput&&(this.elements.categoryInput.style.display="block",this.elements.categoryInput.value="",this.elements.categoryInput.focus()),this.elements.saveCategoryBtn&&(this.elements.saveCategoryBtn.style.display="inline-flex"),this.elements.cancelCategoryBtn&&(this.elements.cancelCategoryBtn.style.display="inline-flex"))},cancelAddCategory(){this.isAddingCategory&&(this.isAddingCategory=!1,this.elements.categoryDropdown&&(this.elements.categoryDropdown.style.display="block"),this.elements.addCategoryBtn&&(this.elements.addCategoryBtn.style.display="inline-flex"),this.elements.deleteCategoryBtn&&(this.elements.deleteCategoryBtn.style.display="inline-flex"),this.elements.categoryInput&&(this.elements.categoryInput.style.display="none",this.elements.categoryInput.value=""),this.elements.saveCategoryBtn&&(this.elements.saveCategoryBtn.style.display="none"),this.elements.cancelCategoryBtn&&(this.elements.cancelCategoryBtn.style.display="none"))},saveCategory(){if(!this.isAddingCategory||!this.elements.categoryInput)return;const e=this.elements.categoryInput.value.trim();e&&(this.categories[e]?(this.currentCategory=e,this.currentIndex=0):(this.categories[e]=[{text:"",rating:0}],this.currentCategory=e,this.currentIndex=0),this.updateCategoryDropdown(),this.updateTextInput(),this.saveTextItems(),this.cancelAddCategory())},deleteCategory(){if(Object.keys(this.categories).length<=1)return;const e=Date.now();if(e-this.lastDeleteClickTime<500){const e=this.currentCategory;delete this.categories[e];const t=Object.keys(this.categories);if(this.currentCategory=t[0],this.currentIndex=0,this.updateCategoryDropdown(),this.updateTextInput(),this.saveTextItems(),this.lastDeleteClickTime=0,this.elements.deleteCategoryBtn){const e=this.elements.deleteCategoryBtn.innerHTML;this.elements.deleteCategoryBtn.innerHTML="&#10003;",setTimeout(()=>{this.elements.deleteCategoryBtn.innerHTML=e},1e3)}}else if(this.lastDeleteClickTime=e,this.elements.deleteCategoryBtn){const e=this.elements.deleteCategoryBtn.style.background;this.elements.deleteCategoryBtn.style.background="#ff6b6b",setTimeout(()=>{this.elements.deleteCategoryBtn.style.background=e},500)}},switchView(e){this.currentView=e,this.elements.textPill&&this.elements.details&&("prompt"===e?(this.elements.textPill.style.display="flex",this.elements.details.style.display="none",this.elements.categoryPill&&(this.elements.categoryPill.style.display="flex")):(this.elements.textPill.style.display="none",this.elements.details.style.display="block",this.elements.categoryPill&&(this.elements.categoryPill.style.display="none")))},toggleVisibility(){this.isHidden=!this.isHidden,this.elements.contentWrapper&&this.elements.toggleBtn&&(this.isHidden?(this.elements.contentWrapper.style.display="none",this.elements.toggleBtn.innerHTML="&#9650;"):(this.elements.contentWrapper.style.display="flex",this.elements.toggleBtn.innerHTML="&#9660;"))},createButton(e,s=!0){const o=document.createElement("button");return Object.assign(o.style,{display:"inline-flex",alignItems:"center",justifyContent:"center",gap:s?t:"0",border:"none",background:p,color:g,padding:`${n} ${i}`,borderRadius:c,cursor:"pointer",fontSize:r,fontWeight:"500",lineHeight:"1.2",outline:"none",transition:`all ${x} ${b}`,minHeight:"auto"}),o.onmouseenter=()=>{o.style.background=u,o.style.color=m},o.onmouseleave=()=>{o.style.background=p,o.style.color=g},o.textContent=e,o},ensure(){if(this.elements.container)return;this.loadTextItems();const k=document.createElement("style");k.textContent="\n            video:fullscreen {\n                width: 100vw;\n                height: 100vh;\n                object-fit: contain;\n            }\n        ",document.head.appendChild(k);const v=document.createElement("div");v.id="grok-media-fetcher",Object.assign(v.style,{position:"fixed",bottom:"72px",right:"24px",zIndex:"99999",fontSize:r,fontFamily:'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',color:h,pointerEvents:"auto",display:"flex",flexDirection:"column",alignItems:"flex-end"}),this.elements.container=v;const w=document.createElement("button");Object.assign(w.style,{display:"flex",alignItems:"center",justifyContent:"center",width:a,height:a,padding:"0",marginBottom:o,border:"none",borderRadius:c,background:d,color:g,fontSize:"14px",cursor:"pointer",outline:"none",transition:`all ${x} ${b}`,boxShadow:`0 4px 12px ${y}`}),w.innerHTML="&#9660;",w.title="Toggle UI",w.addEventListener("click",()=>{this.toggleVisibility()}),w.addEventListener("mouseenter",()=>{w.style.background=u,w.style.color=m}),w.addEventListener("mouseleave",()=>{w.style.background=d,w.style.color=g}),this.elements.toggleBtn=w;const I=document.createElement("div");Object.assign(I.style,{display:"flex",flexDirection:"column"}),this.elements.contentWrapper=I;const T=document.createElement("div");Object.assign(T.style,{display:"flex",flexDirection:"column",gap:t,borderRadius:c,background:d,border:"none",boxShadow:`0 4px 12px ${y}`,marginBottom:l,padding:n}),this.elements.categoryPill=T;const S=document.createElement("div");Object.assign(S.style,{display:"flex",gap:e,alignItems:"center"});const B=document.createElement("select");Object.assign(B.style,{flex:"1",padding:`${s} ${i}`,paddingRight:"32px",border:`1px solid ${f}`,borderRadius:c,background:`${p} url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e") no-repeat right 8px center`,backgroundSize:"16px",color:h,fontSize:r,fontFamily:'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',outline:"none",cursor:"pointer",transition:`all ${x} ${b}`,appearance:"none",WebkitAppearance:"none",MozAppearance:"none"}),B.addEventListener("change",e=>{this.currentCategory=e.target.value,this.currentIndex=0,this.updateTextInput(),this.updateCategoryDropdown(),this.saveTextItems()}),B.addEventListener("focus",()=>{B.style.background=u,B.style.borderColor=g}),B.addEventListener("blur",()=>{B.style.background=p,B.style.borderColor=f}),this.elements.categoryDropdown=B;const E=document.createElement("input");E.type="text",E.placeholder="Category name",Object.assign(E.style,{flex:"1",padding:`${s} ${i}`,border:`1px solid ${f}`,borderRadius:c,background:p,color:h,fontSize:r,fontFamily:'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',outline:"none",display:"none",transition:`all ${x} ${b}`}),E.addEventListener("focus",()=>{E.style.background=u,E.style.borderColor=g}),E.addEventListener("blur",()=>{E.style.background=p,E.style.borderColor=f}),E.addEventListener("keydown",e=>{"Enter"===e.key?this.saveCategory():"Escape"===e.key&&this.cancelAddCategory()}),this.elements.categoryInput=E;const L=this.createButton("+",!1);Object.assign(L.style,{width:a,height:a,minWidth:a,minHeight:a,padding:"0",fontSize:"20px",fontWeight:"bold"}),L.innerHTML="&#43;",L.addEventListener("click",()=>{this.startAddCategory()}),this.elements.addCategoryBtn=L;const M=this.createButton("‚àí",!1);Object.assign(M.style,{width:a,height:a,minWidth:a,minHeight:a,padding:"0",fontSize:"20px",fontWeight:"bold"}),M.innerHTML="&#8722;",M.title="Double-click to delete category",M.addEventListener("click",()=>{this.deleteCategory()}),this.elements.deleteCategoryBtn=M;const D=this.createButton("Save",!1);D.style.display="none",D.addEventListener("click",()=>{this.saveCategory()}),this.elements.saveCategoryBtn=D;const H=this.createButton("Cancel",!1);H.style.display="none",H.addEventListener("click",()=>{this.cancelAddCategory()}),this.elements.cancelCategoryBtn=H,S.appendChild(B),S.appendChild(E),S.appendChild(L),S.appendChild(M),S.appendChild(D),S.appendChild(H),T.appendChild(S);const $=document.createElement("div");Object.assign($.style,{display:"flex",flexDirection:"column",gap:t,borderRadius:c,background:d,border:"none",boxShadow:`0 4px 12px ${y}`,marginBottom:l,padding:n}),this.elements.textPill=$;const A=document.createElement("div");Object.assign(A.style,{display:"flex",gap:t});const U=document.createElement("textarea");U.rows=5,U.placeholder="Enter text...",Object.assign(U.style,{flex:"1",padding:`${s} ${i}`,border:`1px solid ${f}`,borderRadius:c,background:p,color:h,fontSize:r,fontFamily:'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',outline:"none",transition:`all ${x} ${b}`,resize:"vertical"}),U.addEventListener("input",e=>{this.setCurrentPrompt(this.currentIndex,e.target.value),this.saveTextItems()}),U.addEventListener("focus",()=>{U.style.background=u,U.style.borderColor=g}),U.addEventListener("blur",()=>{U.style.background=p,U.style.borderColor=f}),this.elements.textInput=U;const P=document.createElement("div");Object.assign(P.style,{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:e});const F=this.createButton("‚Üê",!1);Object.assign(F.style,{width:a,height:a,minWidth:a,minHeight:a,padding:"0",fontSize:"20px"}),F.innerHTML="&#8592;",F.addEventListener("click",()=>{this.currentIndex>0&&(this.currentIndex--,this.updateTextInput())}),this.elements.prevBtn=F;const G=this.createButton("‚Üí",!1);Object.assign(G.style,{width:a,height:a,minWidth:a,minHeight:a,padding:"0",fontSize:"20px"}),G.innerHTML="&#8594;",G.addEventListener("click",()=>{const e=this.getCurrentPrompts();this.currentIndex<e.length-1&&(this.currentIndex++,this.updateTextInput(),this.saveTextItems())}),this.elements.nextBtn=G;const O=this.createButton("+",!1);Object.assign(O.style,{width:a,height:a,minWidth:a,minHeight:a,padding:"0",fontSize:"20px"}),O.innerHTML="&#43;",O.addEventListener("click",()=>{const e=this.getCurrentPrompts();""!==(e[this.currentIndex]?.text||"").trim()&&(e.push({text:"",rating:0}),this.currentIndex=e.length-1,this.updateTextInput(),this.saveTextItems())}),this.elements.addBtn=O;const j=this.createButton("√ó",!1);Object.assign(j.style,{width:a,height:a,minWidth:a,minHeight:a,padding:"0",fontSize:"20px"}),j.innerHTML="&#215;",j.addEventListener("click",()=>{const e=this.getCurrentPrompts();e.length>1&&(e.splice(this.currentIndex,1),this.currentIndex=Math.min(this.currentIndex,e.length-1),this.updateTextInput(),this.saveTextItems())}),this.elements.removeBtn=j;const R=this.createButton("‚ñ∂",!1);Object.assign(R.style,{width:"100%",height:a,minHeight:a,padding:"0",fontSize:"20px",gridColumn:"1 / 3"}),R.innerHTML="&#9654;",R.title="Copy to page and Make a Video",R.addEventListener("click",()=>{try{const e=document.querySelector('textarea[placeholder="Make a video"]');if(e){const t=this.getCurrentPrompts(),n=t[this.currentIndex]?.text||"";Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value").set.call(e,n);const s=new Event("input",{bubbles:!0});e.dispatchEvent(s),setTimeout(()=>{const e=document.querySelector('button[aria-label="Make video"]');if(e){e.click();const t=R.innerHTML;R.innerHTML="&#10003;",setTimeout(()=>{R.innerHTML=t},1e3)}else R.innerHTML="&#10007;",setTimeout(()=>{R.innerHTML="&#9654;"},1e3)},100)}else R.innerHTML="&#10007;",setTimeout(()=>{R.innerHTML="&#9654;"},1e3)}catch(e){console.error("Failed to play:",e)}}),this.elements.playBtn=R,P.appendChild(F),P.appendChild(G),P.appendChild(O),P.appendChild(j),P.appendChild(R),document.addEventListener("keydown",e=>{if("Enter"===e.key&&(e.ctrlKey||e.metaKey))if(e.preventDefault(),e.shiftKey)R.click();else{const e=document.querySelector('button[aria-label="Make video"]');e&&e.click()}}),A.appendChild(U),A.appendChild(P);const W=document.createElement("div");Object.assign(W.style,{display:"flex",gap:t,justifyContent:"flex-start"});const V=this.createButton("From",!1);V.title="Copy from page input",V.addEventListener("click",()=>{try{const e=document.querySelector('textarea[placeholder="Make a video"]');if(e&&e.value){this.setCurrentPrompt(this.currentIndex,e.value),this.updateTextInput(),this.saveTextItems();const t=V.textContent;V.innerHTML="&#10003;",setTimeout(()=>{V.textContent=t},1e3)}else V.innerHTML="&#10007;",setTimeout(()=>{V.textContent="From"},1e3)}catch(e){console.error("Failed to copy from external textarea:",e)}});const N=this.createButton("To",!1);N.title="Copy to page input",N.addEventListener("click",()=>{try{const e=document.querySelector('textarea[placeholder="Make a video"]');if(e){const t=this.getCurrentPrompts(),n=t[this.currentIndex]?.text||"";Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value").set.call(e,n);const s=new Event("input",{bubbles:!0});e.dispatchEvent(s);const i=N.textContent;N.innerHTML="&#10003;",setTimeout(()=>{N.textContent=i},1e3)}else N.innerHTML="&#10007;",setTimeout(()=>{N.textContent="To"},1e3)}catch(e){console.error("Failed to copy to external textarea:",e)}});const q=this.createButton("Copy",!1);q.addEventListener("click",async()=>{const e=this.getCurrentPrompts(),t=e[this.currentIndex]?.text||"";try{await navigator.clipboard.writeText(t);const e=q.textContent;q.textContent="Copied!",setTimeout(()=>{q.textContent=e},1500)}catch(e){console.error("Failed to copy:",e),q.textContent="Failed",setTimeout(()=>{q.textContent="Copy"},1500)}});const z=document.createElement("div");Object.assign(z.style,{display:"flex",gap:"2px",alignItems:"center",marginLeft:"auto"});for(let e=1;e<=5;e++){const t=document.createElement("span");t.innerHTML="&#9734;",Object.assign(t.style,{cursor:"pointer",fontSize:"18px",color:"#666",transition:"color 0.1s ease",userSelect:"none"}),t.addEventListener("click",()=>{this.setRating(e)}),t.addEventListener("mouseenter",()=>{const t=z.children;for(let n=0;n<t.length;n++)n<e?(t[n].innerHTML="&#9733;",t[n].style.color="#FFD700"):(t[n].innerHTML="&#9734;",t[n].style.color="#666")}),t.addEventListener("mouseleave",()=>{this.updateStarRating()}),z.appendChild(t)}this.elements.starRating=z,W.appendChild(V),W.appendChild(N),W.appendChild(q),W.appendChild(z),$.appendChild(A),$.appendChild(W),this.updateCategoryDropdown(),this.updateTextInput();const K=document.createElement("div");Object.assign(K.style,{display:"inline-flex",alignItems:"center",gap:"8px",padding:n,borderRadius:c,background:d,border:"none",boxShadow:`0 4px 12px ${y}`}),this.elements.pill=K,this.elements.upscaleBtn=this.createButton("Upscale",!1),this.elements.downloadBtn=this.createButton("Download",!1);const _=this.createButton("Prompt",!1);this.elements.promptBtn=_,Object.assign(_.style,{flex:"1"}),Object.assign(this.elements.upscaleBtn.style,{flex:"1"}),Object.assign(this.elements.downloadBtn.style,{flex:"1"}),this.elements.downloadBtn.disabled=!0,this.elements.downloadBtn.style.opacity="0.5",this.elements.downloadBtn.style.cursor="not-allowed",K.appendChild(_),K.appendChild(this.elements.upscaleBtn),K.appendChild(this.elements.downloadBtn);const J=document.createElement("div");Object.assign(J.style,{marginTop:l,padding:`${i} 16px`,borderRadius:c,background:d,border:"none",fontSize:"12px",color:g,display:"none",width:"100%",boxShadow:`0 4px 12px ${y}`}),this.elements.details=J;const Y=document.createElement("div");Y.textContent=C,Y.style.marginBottom=o,this.elements.status=Y;const Q=document.createElement("div");Q.textContent="Upscaled 0 / 0 (HD 0)",this.elements.upscaleInfo=Q,J.appendChild(Y),J.appendChild(Q);const X=document.createElement("div");Object.assign(X.style,{marginTop:l,padding:`${n} ${s}`,borderRadius:"8px",background:d,border:"none",fontSize:"11px",color:g,textAlign:"center",boxShadow:`0 4px 12px ${y}`,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:e});const Z=document.createElement("div");Object.assign(Z.style,{display:"flex",gap:t,alignItems:"center",width:"100%"});const ee=this.createButton("Spin",!1);Object.assign(ee.style,{padding:`${n} ${s}`,flex:"1",height:a,minHeight:a,maxHeight:a}),ee.title="Spin through list items and run them",this.elements.spinBtn=ee;const te=this.createButton("‚õ∂",!1);Object.assign(te.style,{width:a,height:a,minWidth:a,minHeight:a,maxWidth:a,maxHeight:a,padding:"0",fontSize:"20px",flexShrink:"0"}),te.title="Enter fullscreen mode",this.elements.fullscreenBtn=te,Z.appendChild(ee),Z.appendChild(te);const ne=document.createElement("span");ne.textContent="grokGoonify 1.5 by b2kdaman",X.appendChild(Z),X.appendChild(ne),this.elements.footer=X,ee.addEventListener("click",()=>{this.isSpinning?this.stopSpin():this.spin()}),te.addEventListener("click",()=>{this.enterFullscreen()}),I.appendChild(T),I.appendChild($),I.appendChild(J),I.appendChild(K),I.appendChild(X),v.appendChild(w),v.appendChild(I),document.body.appendChild(v),this.switchView("prompt")},attachHandlers(e){this.elements.container&&(this.elements.downloadBtn.addEventListener("click",e.download),this.elements.upscaleBtn.addEventListener("click",e.upscale),this.elements.promptBtn.addEventListener("click",()=>{this.switchView("prompt")}))},showDetails(){this.ensure(),this.switchView("status")},hideDetails(){this.ensure(),this.switchView("prompt")},setStatus(e){this.ensure(),this.elements.status.textContent=e},setUpscaleInfo(e,t,n){this.ensure(),this.elements.upscaleInfo.textContent=`Upscaled ${e} / ${t} (HD ${n})`},enableDownloadButton(){this.ensure(),this.elements.downloadBtn&&(this.elements.downloadBtn.disabled=!1,this.elements.downloadBtn.style.opacity="1",this.elements.downloadBtn.style.cursor="pointer")},disableDownloadButton(){this.ensure(),this.elements.downloadBtn&&(this.elements.downloadBtn.disabled=!0,this.elements.downloadBtn.style.opacity="0.5",this.elements.downloadBtn.style.cursor="not-allowed")},clearLinksWrap(){this.elements.linksWrap&&(this.elements.linksWrap.remove(),this.elements.linksWrap=null)},findRunButton(){const e=document.querySelectorAll("button");for(const t of e)if((t.textContent||t.innerText||"").match(/\d+%/)||"true"===t.dataset.grokGlowApplied)return t;return null},async waitForRunCompletion(){return new Promise(e=>{const t=setInterval(()=>{const n=this.findRunButton();if(!n)return clearInterval(t),void e();const s=(n.textContent||n.innerText||"").match(/(\d+)%/);if(s){if(parseInt(s[1],10)>=100)return void setTimeout(()=>{clearInterval(t),e()},1e3)}else"true"===n.dataset.grokGlowApplied||(clearInterval(t),e())},500);setTimeout(()=>{clearInterval(t),e()},3e5)})},clickListItem(e){if(!e)return console.error("[Grok Spin] No item provided to clickListItem"),!1;console.log("[Grok Spin] Item structure:",{tagName:e.tagName,className:e.className,id:e.id,innerHTML:e.innerHTML.substring(0,200)+"..."});const t=e.querySelector("a");if(t){console.log("[Grok Spin] Found link element, clicking it");try{t.click();const e=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});return t.dispatchEvent(e),console.log("[Grok Spin] ‚úì Clicked link successfully"),!0}catch(e){console.warn("[Grok Spin] Error clicking link:",e)}}const n=e.querySelectorAll("div");console.log(`[Grok Spin] Found ${n.length} nested divs in item`);let s=null;for(let e=0;e<n.length;e++){const t=n[e],i=null!==t.querySelector("button"),o=t.offsetWidth>=100&&t.offsetHeight>0,l=t.textContent&&t.textContent.trim().length>10;if(!i&&o&&l&&0===Array.from(t.querySelectorAll("div")).filter(e=>!e.querySelector("button")&&e.offsetWidth>=100&&e.textContent?.trim().length>10).length){s=t,console.log(`[Grok Spin] Found suitable content div at index ${e}`,{width:t.offsetWidth,height:t.offsetHeight,textLength:t.textContent.trim().length});break}}if(s){console.log("[Grok Spin] Clicking content div");try{s.click();const e=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});return s.dispatchEvent(e),console.log("[Grok Spin] ‚úì Clicked content div successfully"),!0}catch(e){console.warn("[Grok Spin] Error clicking content div:",e)}}console.log("[Grok Spin] Clicking item itself as fallback");try{e.click();const t=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});return e.dispatchEvent(t),console.log("[Grok Spin] ‚úì Clicked item directly successfully"),!0}catch(e){return console.error("[Grok Spin] Error clicking item:",e),!1}},clickMakeVideoButton(){const e=document.querySelector('button[aria-label="Make video"]');return!!e&&(console.log('[Grok Spin] Clicking "Make video" button'),e.click(),!0)},clickBackButton(){const e=document.querySelector('button[aria-label="Back"]');return console.log("[Grok Spin] Looking for Back button..."),e?(console.log("[Grok Spin] Back button found, clicking it"),e.click(),!0):(console.warn("[Grok Spin] Back button NOT found"),!1)},async spin(){if(this.isSpinning)return void console.log("[Grok Spin] Already spinning, skipping...");this.isSpinning=!0,this.shouldStopSpinning=!1;const e=this.elements.spinBtn,t=["‚†ã","‚†ô","‚†π","‚†∏","‚†º","‚†¥","‚†¶","‚†ß","‚†á","‚†è"];let n=0;e&&(e.disabled=!1,e.style.opacity="1",this.spinAnimationInterval=setInterval(()=>{if(e&&this.isSpinning){const s=e.textContent.replace(/^[‚†ã‚†ô‚†π‚†∏‚†º‚†¥‚†¶‚†ß‚†á‚†è]\s*/,"");e.textContent=`${t[n]} ${s}`,n=(n+1)%t.length}},80),e.textContent=`${t[0]} Stop`);try{const t=document.querySelector('div[role="list"]');if(!t)return console.warn('[Grok Spin] No list container found with role="list"'),this.spinAnimationInterval&&(clearInterval(this.spinAnimationInterval),this.spinAnimationInterval=null),void(e&&(e.textContent="No list found",setTimeout(()=>{e.textContent="Spin",e.disabled=!1,e.style.opacity="1",this.isSpinning=!1},2e3)));const n=()=>{const e=t.querySelectorAll('[role="listitem"]');return e.length>0?Array.from(e):Array.from(t.children).filter(e=>"LI"===e.tagName||"listitem"===e.getAttribute("role")||e.querySelector("button"))};let s=n();if(0===s.length)return console.warn("[Grok Spin] No list items found"),this.spinAnimationInterval&&(clearInterval(this.spinAnimationInterval),this.spinAnimationInterval=null),void(e&&(e.textContent="No items found",setTimeout(()=>{e.textContent="Spin",e.disabled=!1,e.style.opacity="1",this.isSpinning=!1},2e3)));const i=s.length;console.log(`[Grok Spin] Found ${i} items to process`);for(let t=0;t<i;t++){if(this.shouldStopSpinning){console.log("[Grok Spin] Stop requested by user");break}const s=n();if(t>=s.length){console.warn(`[Grok Spin] Item ${t+1} no longer exists in DOM, skipping`);continue}const o=s[t];if(console.log(`[Grok Spin] Re-queried list, got fresh reference for item ${t+1}/${i}`),e){const n=["‚†ã","‚†ô","‚†π","‚†∏","‚†º","‚†¥","‚†¶","‚†ß","‚†á","‚†è"],s=n[t%n.length];e.textContent=`${s} Stop (${t+1}/${i})`}try{console.log(`[Grok Spin] Clicking item ${t+1}...`),this.clickListItem(o),await new Promise(e=>setTimeout(e,1e3)),console.log(`[Grok Spin] Item ${t+1} clicked, waiting before next...`),await new Promise(e=>setTimeout(e,2e3)),this.clickBackButton()?(console.log(`[Grok Spin] Clicked Back after item ${t+1}`),await new Promise(e=>setTimeout(e,1e3))):console.warn(`[Grok Spin] Back button not found after item ${t+1}`)}catch(e){console.error(`[Grok Spin] Error processing item ${t+1}:`,e)}}console.log("[Grok Spin] Finished spinning through all items")}catch(e){console.error("[Grok Spin] Error during spin:",e)}finally{this.isSpinning=!1,this.shouldStopSpinning=!1,this.spinAnimationInterval&&(clearInterval(this.spinAnimationInterval),this.spinAnimationInterval=null),e&&(e.disabled=!1,e.style.opacity="1",e.textContent="Spin")}},stopSpin(){console.log("[Grok Spin] Stopping spin..."),this.shouldStopSpinning=!0},enterFullscreen(){try{const e=document.getElementById("hd-video"),t=document.getElementById("sd-video");let n=null;if(n=e&&e.offsetWidth>0&&e.offsetHeight>0&&"none"!==getComputedStyle(e).display&&"hidden"!==getComputedStyle(e).visibility?e:t&&t.offsetWidth>0&&t.offsetHeight>0&&"none"!==getComputedStyle(t).display&&"hidden"!==getComputedStyle(t).visibility?t:e||t,!n){if(this.elements.fullscreenBtn){const e=this.elements.fullscreenBtn.innerHTML;this.elements.fullscreenBtn.innerHTML="&#10007;",setTimeout(()=>{this.elements.fullscreenBtn.innerHTML=e},1e3)}return}let s=n;const i=n.parentElement,o=i?.parentElement;if(o&&(o.classList.contains("video-player")||o.classList.contains("player")||"region"===o.getAttribute("role")||"VIDEO-PLAYER"===o.tagName)?s=o:i&&(i.classList.contains("video-player")||i.classList.contains("player")||"region"===i.getAttribute("role"))&&(s=i),s.requestFullscreen?s.requestFullscreen():s.webkitRequestFullscreen?s.webkitRequestFullscreen():s.msRequestFullscreen&&s.msRequestFullscreen(),this.elements.fullscreenBtn){const e=this.elements.fullscreenBtn.innerHTML;this.elements.fullscreenBtn.innerHTML="&#10003;",setTimeout(()=>{this.elements.fullscreenBtn.innerHTML=e},1e3)}}catch(e){console.error("[Grok Fullscreen] Error:",e)}},renderMediaInfo(e){this.clearLinksWrap();const t=document.createElement("div");if(t.className="grok-media-links",t.style.marginTop=o,e.urls.length){const n=document.createElement("div"),s=e.videosToUpscale.length+e.hdVideoCount;n.textContent=`Media: ${e.urls.length} | Videos: ${s} (HD ${e.hdVideoCount}, ${e.videosToUpscale.length} to upscale)`,n.style.marginTop=o,t.appendChild(n)}else{const e=document.createElement("div");e.textContent="No media URLs detected",t.appendChild(e)}this.elements.details.appendChild(t),this.elements.linksWrap=t}},v=()=>window.location.pathname.split("/").filter(Boolean)[2]||null,w=(e,t=0)=>e.split("?")[0].split("/").filter(Boolean).pop()||`media_${t+1}`,I=e=>e&&(e.hdMediaUrl||e.mediaUrl||e.thumbnailImageUrl||null),T=(e,t)=>e+Math.random()*(t-e),S=()=>(new Date).toLocaleTimeString(),B=()=>"function"==typeof GM_download,E={lastMediaUrls:[],lastVideoIdsToUpscale:[],lastHdVideoCount:0,upscaleTotal:0,upscaleDone:0,isUpscaling:!1,upscaleRefetchTimeout:null,upscaleTimeoutIds:[],urlWatcherInterval:null,lastKnownPostId:null,resetForNewPost(e){for(this.lastMediaUrls=[],this.lastVideoIdsToUpscale=[],this.lastHdVideoCount=0,this.upscaleTotal=0,this.upscaleDone=0,this.isUpscaling=!1,this.upscaleRefetchTimeout&&(clearTimeout(this.upscaleRefetchTimeout),this.upscaleRefetchTimeout=null);this.upscaleTimeoutIds.length;){const e=this.upscaleTimeoutIds.pop();clearTimeout(e)}}},L={start(){E.urlWatcherInterval||(E.lastKnownPostId=v(),this.resetForNewPost(E.lastKnownPostId),E.urlWatcherInterval=setInterval(()=>{const e=v();e!==E.lastKnownPostId&&(E.lastKnownPostId=e,this.resetForNewPost(e))},500))},resetForNewPost(e){E.resetForNewPost(e),k.clearLinksWrap(),k.setUpscaleInfo(0,0,0),k.hideDetails(),e?k.setStatus(C):k.setStatus("Waiting for post‚Ä¶")}},M={async fetchPostData(e){const t=await fetch("/rest/media/post/get",{method:"POST",headers:{accept:"*/*","content-type":"application/json"},body:JSON.stringify({id:e})});if(!t.ok)throw new Error(`HTTP ${t.status}`);return t.json()},async upscaleVideo(e){const t=await fetch("/rest/media/video/upscale",{method:"POST",headers:{accept:"*/*","content-type":"application/json"},body:JSON.stringify({videoId:e})});if(!t.ok)throw new Error(`Upscale HTTP ${t.status}`);const n=await t.json().catch(()=>null);return console.log("[Grok Media Fetcher] Upscale response for",e,n),n}},D={processPostData(e){const t=[],n=[];let s=0;return Array.isArray(e.childPosts)&&e.childPosts.length>0&&e.childPosts.forEach(e=>{const i=I(e);i&&t.push(i),"MEDIA_POST_TYPE_VIDEO"===e.mediaType&&(e.hdMediaUrl?s+=1:e.id&&n.push(e.id))}),{urls:Array.from(new Set(t)),videosToUpscale:Array.from(new Set(n)),hdVideoCount:s}}},H={async fetchAndRender(){k.ensure();const e=v();if(e)try{const t=await M.fetchPostData(e);window.grokPostData=t,console.log("[Grok Media Fetcher] Response:",t);const n=t.post||{};k.setStatus("‚úÖ Fetched @ "+S());const s=D.processPostData(n);E.lastMediaUrls=s.urls,E.lastVideoIdsToUpscale=s.videosToUpscale,E.lastHdVideoCount=s.hdVideoCount,k.renderMediaInfo(s),E.isUpscaling||(E.upscaleTotal=s.videosToUpscale.length,E.upscaleDone=0),k.setUpscaleInfo(E.upscaleDone,E.upscaleTotal,E.lastHdVideoCount),0===s.videosToUpscale.length&&k.enableDownloadButton()}catch(e){console.error("[Grok Media Fetcher] Error:",e),k.setStatus("‚ùå Error (see console)")}else k.setStatus("‚ùå Could not detect post ID")},startUpscaleRefetchLoop(){if(E.upscaleRefetchTimeout)return;const e=async()=>{if(!E.isUpscaling||E.upscaleDone>=E.upscaleTotal)return void(E.upscaleRefetchTimeout=null);try{await this.fetchAndRender()}catch(e){console.error("[Grok Media Fetcher] Upscale-refetch error:",e)}const t=T(3e3,5e3);E.upscaleRefetchTimeout=setTimeout(e,t)};e()},async processUpscaleBatch(){E.isUpscaling=!0,E.upscaleTotal=E.lastVideoIdsToUpscale.length,E.upscaleDone=0,k.setUpscaleInfo(E.upscaleDone,E.upscaleTotal,E.lastHdVideoCount),k.setStatus("üöÄ Upscaling started..."),k.disableDownloadButton(),this.startUpscaleRefetchLoop(),E.upscaleTimeoutIds.splice(0,E.upscaleTimeoutIds.length);const e=[...E.lastVideoIdsToUpscale],t=e.length;let n=0;e.forEach((e,s)=>{const i=T(1e3,2e3);n+=i;const o=setTimeout(async()=>{try{await M.upscaleVideo(e),E.upscaleDone+=1,k.setUpscaleInfo(E.upscaleDone,E.upscaleTotal,E.lastHdVideoCount)}catch(t){console.error("[Grok Media Fetcher] Upscale error for",e,t)}s===t-1&&(E.isUpscaling=!1,k.setStatus("‚úÖ Upscale batch finished, fetching results..."),setTimeout(async()=>{try{await this.fetchAndRender(),k.setStatus("‚úÖ Upscale complete with updated media"),k.enableDownloadButton()}catch(e){console.error("[Grok Media Fetcher] Final fetch error:",e),k.setStatus("‚úÖ Upscale finished (fetch failed)"),k.enableDownloadButton()}},2e3))},n);E.upscaleTimeoutIds.push(o)})}},$={fallback(e,t){const n=document.createElement("a");n.href=e,n.download=t,n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)},withGmDownload(e,t){try{GM_download({url:e,name:t,saveAs:!1,onerror:n=>{console.error("[Grok Media Fetcher] GM_download error, fallback triggered:",n),this.fallback(e,t)}})}catch(n){console.error("[Grok Media Fetcher] GM_download threw, fallback triggered:",n),this.fallback(e,t)}},trigger(e){const t=B();e.forEach((e,n)=>{setTimeout(()=>{const s=w(e,n);t?this.withGmDownload(e,s):this.fallback(e,s)},500*n)})}},A={async download(){k.showDetails(),k.setStatus("üîÑ Fetching latest data..."),await H.fetchAndRender(),E.lastMediaUrls&&0!==E.lastMediaUrls.length?(k.setStatus(`‚¨á Downloading ${E.lastMediaUrls.length} item(s)...`),$.trigger(E.lastMediaUrls)):k.setStatus("‚ö†Ô∏è Nothing to download ‚Äì no media found")},async upscale(){k.showDetails(),E.isUpscaling?k.setStatus("‚è≥ Already upscaling..."):(await H.fetchAndRender(),E.lastVideoIdsToUpscale&&0!==E.lastVideoIdsToUpscale.length?await H.processUpscaleBatch():k.setStatus("‚ö†Ô∏è No videos to upscale (either none or already HD)"))}};function U(e){if(e&&!e.dataset.grokGlowApplied&&(e.dataset.grokGlowApplied="true",e.style.boxShadow="0 0 20px rgba(255, 255, 255, 0.6), 0 0 40px rgba(255, 255, 255, 0.4)",e.style.transition="box-shadow 0.3s ease",!document.getElementById("grok-glow-style"))){const e=document.createElement("style");e.id="grok-glow-style",e.textContent='\n                @keyframes grok-glow-pulse {\n                    0%, 100% {\n                        box-shadow: 0 0 20px rgba(255, 255, 255, 0.6), 0 0 40px rgba(255, 255, 255, 0.4);\n                    }\n                    50% {\n                        box-shadow: 0 0 30px rgba(255, 255, 255, 0.8), 0 0 60px rgba(255, 255, 255, 0.6);\n                    }\n                }\n                button[data-grok-glow-applied="true"] {\n                    animation: grok-glow-pulse 2s ease-in-out infinite;\n                }\n            ',document.head.appendChild(e)}}function P(){console.log("%c grokGoonify v1.5.0 %c by b2kdaman ","background: #1a1a1a; color: #fff; padding: 4px 8px; border-radius: 3px 0 0 3px; font-weight: bold;","background: #3a3a3a; color: #b0b0b0; padding: 4px 8px; border-radius: 0 3px 3px 0;"),k.ensure(),k.attachHandlers(A),L.start(),function(){let e=null,t=null,n=null;function s(){n&&(n.remove(),n=null)}function i(){const i=function(){if(!e||!document.body.contains(e)){const t=document.querySelectorAll("button");for(const n of t)if((n.textContent||n.innerText||"").match(/\d+%/)){e=n,U(e);break}}return e}();if(i){const o=(i.textContent||i.innerText||"").match(/(\d+)%/);if(o){const i=parseInt(o[1],10);100===i?(s(),t=null,e=null):((n||(n=document.createElement("div"),n.id="grok-progress-bar",Object.assign(n.style,{position:"fixed",top:"0",left:"0",height:"7px",width:"0%",background:"rgba(255, 255, 255, 0.5)",zIndex:"999",transition:"width 0.3s ease",pointerEvents:"none"}),document.body.appendChild(n),n)).style.width=`${i}%`,i!==t&&(t=i))}else null!==t&&(s(),t=null,e=null)}else n&&(s(),t=null)}i(),setInterval(i,500)}()}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",P):P()})();
})();