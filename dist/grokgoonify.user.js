// ==UserScript==
// @name         grokGoonify
// @namespace    http://tampermonkey.net/
// @version      1.4
// @description  Grok Media Post Fetcher + Downloader + Upscaler with text note management
// @author       b2kdaman
// @match        https://grok.com/imagine/post/*
// @match        https://www.grok.com/imagine/post/*
// @run-at       document-idle
// @grant        GM_download
// ==/UserScript==



(function () {
    'use strict';

(()=>{var e="6px",t="4px",s="8px",n="12px",o="2px",a="8px",i="13px",r="16px",l="#1a1a1a",c="#2a2a2a",d="#3a3a3a",p="#fff",h="#b0b0b0",u="rgba(0,0,0,0.4)",m="rgba(255, 255, 255, 0.2)",g="0.2s",y="ease",x="Ready",C={elements:{container:null,pill:null,textPill:null,textInput:null,categoryDropdown:null,addCategoryBtn:null,categoryInput:null,saveCategoryBtn:null,cancelCategoryBtn:null,prevBtn:null,nextBtn:null,addBtn:null,removeBtn:null,details:null,status:null,upscaleInfo:null,fetchBtn:null,downloadBtn:null,upscaleBtn:null,promptBtn:null,linksWrap:null},categories:{},currentCategory:"Default",currentIndex:0,currentView:"prompt",isAddingCategory:!1,loadTextItems(){try{const e=localStorage.getItem("grok-text-items");if(!e)return this.categories={Default:[""]},this.currentCategory="Default",void(this.currentIndex=0);const t=JSON.parse(e);Array.isArray(t)?(this.categories={Default:t.length>0?t:[""]},this.currentCategory="Default",this.currentIndex=0,this.saveTextItems()):(this.categories=t.categories||{Default:[""]},this.currentCategory=t.currentCategory||"Default",this.currentIndex=t.currentIndex||0,this.categories[this.currentCategory]||(this.currentCategory="Default",this.currentIndex=0))}catch(e){console.error("Failed to load text items:",e),this.categories={Default:[""]},this.currentCategory="Default",this.currentIndex=0}},saveTextItems(){try{const e={categories:this.categories,currentCategory:this.currentCategory,currentIndex:this.currentIndex};localStorage.setItem("grok-text-items",JSON.stringify(e))}catch(e){console.error("Failed to save text items:",e)}},getCurrentPrompts(){return this.categories[this.currentCategory]||[""]},setCurrentPrompt(e,t){this.categories[this.currentCategory]||(this.categories[this.currentCategory]=[""]),this.categories[this.currentCategory][e]=t},updateTextInput(){if(this.elements.textInput){const e=this.getCurrentPrompts();this.elements.textInput.value=e[this.currentIndex]||""}this.updateNavButtons()},updateNavButtons(){const e=this.getCurrentPrompts();this.elements.prevBtn&&(this.elements.prevBtn.disabled=0===this.currentIndex,this.elements.prevBtn.style.opacity=0===this.currentIndex?"0.3":"1"),this.elements.nextBtn&&(this.elements.nextBtn.disabled=this.currentIndex>=e.length-1,this.elements.nextBtn.style.opacity=this.currentIndex>=e.length-1?"0.3":"1"),this.elements.removeBtn&&(this.elements.removeBtn.disabled=e.length<=1,this.elements.removeBtn.style.opacity=e.length<=1?"0.3":"1")},updateCategoryDropdown(){this.elements.categoryDropdown&&(this.elements.categoryDropdown.innerHTML="",Object.keys(this.categories).forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,e===this.currentCategory&&(t.selected=!0),this.elements.categoryDropdown.appendChild(t)}))},startAddCategory(){this.isAddingCategory||(this.isAddingCategory=!0,this.elements.categoryDropdown&&(this.elements.categoryDropdown.style.display="none"),this.elements.addCategoryBtn&&(this.elements.addCategoryBtn.style.display="none"),this.elements.categoryInput&&(this.elements.categoryInput.style.display="block",this.elements.categoryInput.value="",this.elements.categoryInput.focus()),this.elements.saveCategoryBtn&&(this.elements.saveCategoryBtn.style.display="inline-flex"),this.elements.cancelCategoryBtn&&(this.elements.cancelCategoryBtn.style.display="inline-flex"))},cancelAddCategory(){this.isAddingCategory&&(this.isAddingCategory=!1,this.elements.categoryDropdown&&(this.elements.categoryDropdown.style.display="block"),this.elements.addCategoryBtn&&(this.elements.addCategoryBtn.style.display="inline-flex"),this.elements.categoryInput&&(this.elements.categoryInput.style.display="none",this.elements.categoryInput.value=""),this.elements.saveCategoryBtn&&(this.elements.saveCategoryBtn.style.display="none"),this.elements.cancelCategoryBtn&&(this.elements.cancelCategoryBtn.style.display="none"))},saveCategory(){if(!this.isAddingCategory||!this.elements.categoryInput)return;const e=this.elements.categoryInput.value.trim();e&&(this.categories[e]?(this.currentCategory=e,this.currentIndex=0):(this.categories[e]=[""],this.currentCategory=e,this.currentIndex=0),this.updateCategoryDropdown(),this.updateTextInput(),this.saveTextItems(),this.cancelAddCategory())},switchView(e){this.currentView=e,this.elements.textPill&&this.elements.details&&("prompt"===e?(this.elements.textPill.style.display="flex",this.elements.details.style.display="none",this.elements.categoryPill&&(this.elements.categoryPill.style.display="flex")):(this.elements.textPill.style.display="none",this.elements.details.style.display="block",this.elements.categoryPill&&(this.elements.categoryPill.style.display="none")))},createButton(s,o=!0){const a=document.createElement("button");return Object.assign(a.style,{display:"inline-flex",alignItems:"center",justifyContent:"center",gap:o?e:"0",border:"none",background:c,color:h,padding:`${t} ${n}`,borderRadius:r,cursor:"pointer",fontSize:i,fontWeight:"500",lineHeight:"1.2",outline:"none",transition:`all ${g} ${y}`,minHeight:"auto"}),a.onmouseenter=()=>{a.style.background=d,a.style.color="#d0d0d0"},a.onmouseleave=()=>{a.style.background=c,a.style.color=h},a.textContent=s,a},ensure(){if(this.elements.container)return;this.loadTextItems();const C=document.createElement("div");C.id="grok-media-fetcher",Object.assign(C.style,{position:"fixed",bottom:"72px",right:"24px",zIndex:"99999",fontSize:i,fontFamily:'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',color:p,pointerEvents:"auto"}),this.elements.container=C;const f=document.createElement("div");Object.assign(f.style,{display:"flex",flexDirection:"column",gap:e,borderRadius:r,background:l,border:"none",boxShadow:`0 4px 12px ${u}`,marginBottom:a,padding:t}),this.elements.categoryPill=f;const v=document.createElement("div");Object.assign(v.style,{display:"flex",gap:"4px",alignItems:"center"});const I=document.createElement("select");Object.assign(I.style,{flex:"1",padding:`${s} ${n}`,paddingRight:"32px",border:`1px solid ${m}`,borderRadius:r,background:`${c} url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e") no-repeat right 8px center`,backgroundSize:"16px",color:p,fontSize:i,fontFamily:'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',outline:"none",cursor:"pointer",transition:`all ${g} ${y}`,appearance:"none",WebkitAppearance:"none",MozAppearance:"none"}),I.addEventListener("change",e=>{this.currentCategory=e.target.value,this.currentIndex=0,this.updateTextInput(),this.updateCategoryDropdown(),this.saveTextItems()}),I.addEventListener("focus",()=>{I.style.background=d,I.style.borderColor=h}),I.addEventListener("blur",()=>{I.style.background=c,I.style.borderColor=m}),this.elements.categoryDropdown=I;const b=document.createElement("input");b.type="text",b.placeholder="Category name",Object.assign(b.style,{flex:"1",padding:`${s} ${n}`,border:`1px solid ${m}`,borderRadius:r,background:c,color:p,fontSize:i,fontFamily:'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',outline:"none",display:"none",transition:`all ${g} ${y}`}),b.addEventListener("focus",()=>{b.style.background=d,b.style.borderColor=h}),b.addEventListener("blur",()=>{b.style.background=c,b.style.borderColor=m}),b.addEventListener("keydown",e=>{"Enter"===e.key?this.saveCategory():"Escape"===e.key&&this.cancelAddCategory()}),this.elements.categoryInput=b;const w=this.createButton("+",!1);Object.assign(w.style,{minWidth:"32px",minHeight:"32px",fontSize:"20px",fontWeight:"bold"}),w.innerHTML="&#43;",w.addEventListener("click",()=>{this.startAddCategory()}),this.elements.addCategoryBtn=w;const T=this.createButton("Save",!1);T.style.display="none",T.addEventListener("click",()=>{this.saveCategory()}),this.elements.saveCategoryBtn=T;const k=this.createButton("Cancel",!1);k.style.display="none",k.addEventListener("click",()=>{this.cancelAddCategory()}),this.elements.cancelCategoryBtn=k,v.appendChild(I),v.appendChild(b),v.appendChild(w),v.appendChild(T),v.appendChild(k),f.appendChild(v);const B=document.createElement("div");Object.assign(B.style,{display:"flex",flexDirection:"column",gap:e,borderRadius:r,background:l,border:"none",boxShadow:`0 4px 12px ${u}`,marginBottom:a,padding:t}),this.elements.textPill=B;const E=document.createElement("div");Object.assign(E.style,{display:"flex",gap:e});const D=document.createElement("textarea");D.rows=3,D.placeholder="Enter text...",Object.assign(D.style,{flex:"1",padding:`${s} ${n}`,border:`1px solid ${m}`,borderRadius:r,background:c,color:p,fontSize:i,fontFamily:'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',outline:"none",transition:`all ${g} ${y}`,resize:"vertical"}),D.addEventListener("input",e=>{this.setCurrentPrompt(this.currentIndex,e.target.value),this.saveTextItems()}),D.addEventListener("focus",()=>{D.style.background=d,D.style.borderColor=h}),D.addEventListener("blur",()=>{D.style.background=c,D.style.borderColor=m}),this.elements.textInput=D;const S=document.createElement("div");Object.assign(S.style,{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:"4px"});const U=this.createButton("‚Üê",!1);U.innerHTML="&#8592;",U.style.fontSize="20px",U.addEventListener("click",()=>{this.currentIndex>0&&(this.currentIndex--,this.updateTextInput())}),this.elements.prevBtn=U;const P=this.createButton("‚Üí",!1);P.innerHTML="&#8594;",P.style.fontSize="20px",P.addEventListener("click",()=>{const e=this.getCurrentPrompts();this.currentIndex<e.length-1&&(this.currentIndex++,this.updateTextInput(),this.saveTextItems())}),this.elements.nextBtn=P;const M=this.createButton("+",!1);M.innerHTML="&#43;",M.style.fontSize="20px",M.addEventListener("click",()=>{const e=this.getCurrentPrompts();""!==(e[this.currentIndex]||"").trim()&&(e.push(""),this.currentIndex=e.length-1,this.updateTextInput(),this.saveTextItems())}),this.elements.addBtn=M;const L=this.createButton("√ó",!1);L.innerHTML="&#215;",L.style.fontSize="20px",L.addEventListener("click",()=>{const e=this.getCurrentPrompts();e.length>1&&(e.splice(this.currentIndex,1),this.currentIndex=Math.min(this.currentIndex,e.length-1),this.updateTextInput(),this.saveTextItems())}),this.elements.removeBtn=L,S.appendChild(U),S.appendChild(P),S.appendChild(M),S.appendChild(L),E.appendChild(D),E.appendChild(S);const $=document.createElement("div");Object.assign($.style,{display:"flex",gap:e,justifyContent:"flex-start"});const F=this.createButton("From",!1);F.title="Copy from page input",F.addEventListener("click",()=>{try{const e=document.querySelector('textarea[placeholder="Make a video"]');if(e&&e.value){this.setCurrentPrompt(this.currentIndex,e.value),this.updateTextInput(),this.saveTextItems();const t=F.textContent;F.innerHTML="&#10003;",setTimeout(()=>{F.textContent=t},1e3)}else F.innerHTML="&#10007;",setTimeout(()=>{F.textContent="From"},1e3)}catch(e){console.error("Failed to copy from external textarea:",e)}});const A=this.createButton("To",!1);A.title="Copy to page input",A.addEventListener("click",()=>{try{const e=document.querySelector('textarea[placeholder="Make a video"]');if(e){const t=this.getCurrentPrompts()[this.currentIndex]||"";Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value").set.call(e,t);const s=new Event("input",{bubbles:!0});e.dispatchEvent(s);const n=A.textContent;A.innerHTML="&#10003;",setTimeout(()=>{A.textContent=n},1e3)}else A.innerHTML="&#10007;",setTimeout(()=>{A.textContent="To"},1e3)}catch(e){console.error("Failed to copy to external textarea:",e)}});const H=this.createButton("Copy",!1);H.addEventListener("click",async()=>{const e=this.getCurrentPrompts()[this.currentIndex]||"";try{await navigator.clipboard.writeText(e);const t=H.textContent;H.textContent="Copied!",setTimeout(()=>{H.textContent=t},1500)}catch(e){console.error("Failed to copy:",e),H.textContent="Failed",setTimeout(()=>{H.textContent="Copy"},1500)}}),$.appendChild(F),$.appendChild(A),$.appendChild(H),B.appendChild(E),B.appendChild($),this.updateCategoryDropdown(),this.updateTextInput();const R=document.createElement("div");Object.assign(R.style,{display:"inline-flex",alignItems:"center",gap:"8px",padding:t,borderRadius:r,background:l,border:"none",boxShadow:`0 4px 12px ${u}`}),this.elements.pill=R;const V=this.createButton("Fetch",!1);V.style.color=h,this.elements.fetchBtn=V,this.elements.upscaleBtn=this.createButton("Upscale",!1),this.elements.downloadBtn=this.createButton("Download",!1);const O=this.createButton("Prompt",!1);this.elements.promptBtn=O,R.appendChild(O),R.appendChild(V),R.appendChild(this.elements.upscaleBtn),R.appendChild(this.elements.downloadBtn);const j=document.createElement("div");Object.assign(j.style,{marginTop:a,padding:`${n} 16px`,borderRadius:r,background:l,border:"none",fontSize:"12px",color:h,display:"none",maxWidth:"280px",boxShadow:`0 4px 12px ${u}`}),this.elements.details=j;const W=document.createElement("div");W.textContent=x,W.style.marginBottom=o,this.elements.status=W;const z=document.createElement("div");z.textContent="Upscaled 0 / 0 (HD 0)",this.elements.upscaleInfo=z,j.appendChild(W),j.appendChild(z);const G=document.createElement("div");Object.assign(G.style,{marginTop:a,padding:`${t} ${s}`,borderRadius:"8px",background:l,border:"none",fontSize:"11px",color:h,textAlign:"center",boxShadow:`0 4px 12px ${u}`}),G.textContent="grokGoonify 1.4 by b2kdaman",this.elements.footer=G,C.appendChild(f),C.appendChild(B),C.appendChild(j),C.appendChild(R),C.appendChild(G),document.body.appendChild(C),this.switchView("prompt")},attachHandlers(e){this.elements.container&&(this.elements.fetchBtn.addEventListener("click",e.fetch),this.elements.downloadBtn.addEventListener("click",e.download),this.elements.upscaleBtn.addEventListener("click",e.upscale),this.elements.promptBtn.addEventListener("click",()=>{this.switchView("prompt")}))},showDetails(){this.ensure(),this.switchView("status")},hideDetails(){this.ensure(),this.switchView("prompt")},setStatus(e){this.ensure(),this.elements.status.textContent=e},setUpscaleInfo(e,t,s){this.ensure(),this.elements.upscaleInfo.textContent=`Upscaled ${e} / ${t} (HD ${s})`},clearLinksWrap(){this.elements.linksWrap&&(this.elements.linksWrap.remove(),this.elements.linksWrap=null)},renderMediaInfo(e){this.clearLinksWrap();const t=document.createElement("div");if(t.className="grok-media-links",t.style.marginTop=o,e.urls.length){const s=document.createElement("div"),n=e.videosToUpscale.length+e.hdVideoCount;s.textContent=`Media: ${e.urls.length} | Videos: ${n} (HD ${e.hdVideoCount}, ${e.videosToUpscale.length} to upscale)`,s.style.marginTop=o,t.appendChild(s)}else{const e=document.createElement("div");e.textContent="No media URLs detected",t.appendChild(e)}this.elements.details.appendChild(t),this.elements.linksWrap=t}},f=()=>window.location.pathname.split("/").filter(Boolean)[2]||null,v=(e,t=0)=>e.split("?")[0].split("/").filter(Boolean).pop()||`media_${t+1}`,I=e=>e&&(e.hdMediaUrl||e.mediaUrl||e.thumbnailImageUrl||null),b=(e,t)=>e+Math.random()*(t-e),w=()=>(new Date).toLocaleTimeString(),T=()=>"function"==typeof GM_download,k={lastMediaUrls:[],lastVideoIdsToUpscale:[],lastHdVideoCount:0,upscaleTotal:0,upscaleDone:0,isUpscaling:!1,upscaleRefetchTimeout:null,upscaleTimeoutIds:[],urlWatcherInterval:null,lastKnownPostId:null,resetForNewPost(e){for(this.lastMediaUrls=[],this.lastVideoIdsToUpscale=[],this.lastHdVideoCount=0,this.upscaleTotal=0,this.upscaleDone=0,this.isUpscaling=!1,this.upscaleRefetchTimeout&&(clearTimeout(this.upscaleRefetchTimeout),this.upscaleRefetchTimeout=null);this.upscaleTimeoutIds.length;){const e=this.upscaleTimeoutIds.pop();clearTimeout(e)}}},B={start(){k.urlWatcherInterval||(k.lastKnownPostId=f(),this.resetForNewPost(k.lastKnownPostId),k.urlWatcherInterval=setInterval(()=>{const e=f();e!==k.lastKnownPostId&&(k.lastKnownPostId=e,this.resetForNewPost(e))},500))},resetForNewPost(e){k.resetForNewPost(e),C.clearLinksWrap(),C.setUpscaleInfo(0,0,0),C.hideDetails(),e?C.setStatus(x):C.setStatus("Waiting for post‚Ä¶")}},E={async fetchPostData(e){const t=await fetch("/rest/media/post/get",{method:"POST",headers:{accept:"*/*","content-type":"application/json"},body:JSON.stringify({id:e})});if(!t.ok)throw new Error(`HTTP ${t.status}`);return t.json()},async upscaleVideo(e){const t=await fetch("/rest/media/video/upscale",{method:"POST",headers:{accept:"*/*","content-type":"application/json"},body:JSON.stringify({videoId:e})});if(!t.ok)throw new Error(`Upscale HTTP ${t.status}`);const s=await t.json().catch(()=>null);return console.log("[Grok Media Fetcher] Upscale response for",e,s),s}},D={processPostData(e){const t=[],s=[];let n=0;return Array.isArray(e.childPosts)&&e.childPosts.length>0&&e.childPosts.forEach(e=>{const o=I(e);o&&t.push(o),"MEDIA_POST_TYPE_VIDEO"===e.mediaType&&(e.hdMediaUrl?n+=1:e.id&&s.push(e.id))}),{urls:Array.from(new Set(t)),videosToUpscale:Array.from(new Set(s)),hdVideoCount:n}}},S={async fetchAndRender(){C.ensure();const e=f();if(e)try{const t=await E.fetchPostData(e);window.grokPostData=t,console.log("[Grok Media Fetcher] Response:",t);const s=t.post||{};C.setStatus("‚úÖ Fetched @ "+w());const n=D.processPostData(s);k.lastMediaUrls=n.urls,k.lastVideoIdsToUpscale=n.videosToUpscale,k.lastHdVideoCount=n.hdVideoCount,C.renderMediaInfo(n),k.isUpscaling||(k.upscaleTotal=n.videosToUpscale.length,k.upscaleDone=0),C.setUpscaleInfo(k.upscaleDone,k.upscaleTotal,k.lastHdVideoCount)}catch(e){console.error("[Grok Media Fetcher] Error:",e),C.setStatus("‚ùå Error (see console)")}else C.setStatus("‚ùå Could not detect post ID")},startUpscaleRefetchLoop(){if(k.upscaleRefetchTimeout)return;const e=async()=>{if(!k.isUpscaling||k.upscaleDone>=k.upscaleTotal)return void(k.upscaleRefetchTimeout=null);try{await this.fetchAndRender()}catch(e){console.error("[Grok Media Fetcher] Upscale-refetch error:",e)}const t=b(3e3,5e3);k.upscaleRefetchTimeout=setTimeout(e,t)};e()},async processUpscaleBatch(){k.isUpscaling=!0,k.upscaleTotal=k.lastVideoIdsToUpscale.length,k.upscaleDone=0,C.setUpscaleInfo(k.upscaleDone,k.upscaleTotal,k.lastHdVideoCount),C.setStatus("üöÄ Upscaling started..."),this.startUpscaleRefetchLoop(),k.upscaleTimeoutIds.splice(0,k.upscaleTimeoutIds.length);const e=[...k.lastVideoIdsToUpscale],t=e.length;let s=0;e.forEach((e,n)=>{const o=b(1e3,2e3);s+=o;const a=setTimeout(async()=>{try{await E.upscaleVideo(e),k.upscaleDone+=1,C.setUpscaleInfo(k.upscaleDone,k.upscaleTotal,k.lastHdVideoCount)}catch(t){console.error("[Grok Media Fetcher] Upscale error for",e,t)}n===t-1&&(k.isUpscaling=!1,C.setStatus("‚úÖ Upscale batch finished, fetching results..."),setTimeout(async()=>{try{await this.fetchAndRender(),C.setStatus("‚úÖ Upscale complete with updated media")}catch(e){console.error("[Grok Media Fetcher] Final fetch error:",e),C.setStatus("‚úÖ Upscale finished (fetch failed)")}},2e3))},s);k.upscaleTimeoutIds.push(a)})}},U={fallback(e,t){const s=document.createElement("a");s.href=e,s.download=t,s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s)},withGmDownload(e,t){try{GM_download({url:e,name:t,saveAs:!1,onerror:s=>{console.error("[Grok Media Fetcher] GM_download error, fallback triggered:",s),this.fallback(e,t)}})}catch(s){console.error("[Grok Media Fetcher] GM_download threw, fallback triggered:",s),this.fallback(e,t)}},trigger(e){const t=T();e.forEach((e,s)=>{setTimeout(()=>{const n=v(e,s);t?this.withGmDownload(e,n):this.fallback(e,n)},500*s)})}},P={async fetch(){await S.fetchAndRender(),C.showDetails()},async download(){C.showDetails(),C.setStatus("üîÑ Fetching latest data..."),await S.fetchAndRender(),k.lastMediaUrls&&0!==k.lastMediaUrls.length?(C.setStatus(`‚¨á Downloading ${k.lastMediaUrls.length} item(s)...`),U.trigger(k.lastMediaUrls)):C.setStatus("‚ö†Ô∏è Nothing to download ‚Äì no media found")},async upscale(){C.showDetails(),k.isUpscaling?C.setStatus("‚è≥ Already upscaling..."):(await S.fetchAndRender(),k.lastVideoIdsToUpscale&&0!==k.lastVideoIdsToUpscale.length?await S.processUpscaleBatch():C.setStatus("‚ö†Ô∏è No videos to upscale (either none or already HD)"))}};function M(){C.ensure(),C.attachHandlers(P),B.start()}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",M):M()})();
})();