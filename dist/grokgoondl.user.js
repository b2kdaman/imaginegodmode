// ==UserScript==
// @name         Grok Media Post Fetcher + Downloader + Upscaler (Pill UI Right + HD aware + Upscale refetch)
// @namespace    http://tampermonkey.net/
// @version      1.6
// @description  Fetch media post JSON from grok.com/imagine/post/* and show/download/upscale media with Grok-like pill UI, HD-aware, with refetch during upscale batch
// @author       you
// @match        https://grok.com/imagine/post/*
// @match        https://www.grok.com/imagine/post/*
// @run-at       document-idle
// @grant        GM_download
// ==/UserScript==



(function () {
    'use strict';

(()=>{var e="12px",t="16px",s="2px",n="999px",a="#1a1a1a",o="#2a2a2a",l="#b0b0b0",i="rgba(0,0,0,0.4)",c="Ready",d={elements:{container:null,pill:null,details:null,status:null,upscaleInfo:null,fetchBtn:null,downloadBtn:null,upscaleBtn:null,moreBtn:null,linksWrap:null},createButton(e,s=!0){const a=document.createElement("button");return Object.assign(a.style,{display:"inline-flex",alignItems:"center",justifyContent:"center",gap:s?"6px":"0",border:"none",background:o,color:l,padding:`8px ${t}`,borderRadius:n,cursor:"pointer",fontSize:"14px",fontWeight:"500",lineHeight:"1.2",outline:"none",transition:"all 0.2s ease",minHeight:"36px"}),a.onmouseenter=()=>{a.style.background="#3a3a3a",a.style.color="#d0d0d0"},a.onmouseleave=()=>{a.style.background=o,a.style.color=l},a.textContent=e,a},ensure(){if(this.elements.container)return;const o=document.createElement("div");o.id="grok-media-fetcher",Object.assign(o.style,{position:"fixed",bottom:"72px",right:"24px",zIndex:"99999",fontSize:"13px",fontFamily:'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',color:"#fff",pointerEvents:"auto"}),this.elements.container=o;const d=document.createElement("div");Object.assign(d.style,{display:"inline-flex",alignItems:"center",gap:"8px",padding:"4px",borderRadius:n,background:a,border:"none",boxShadow:`0 4px 12px ${i}`}),this.elements.pill=d;const r=this.createButton("Fetch",!1);r.style.color=l,this.elements.fetchBtn=r,this.elements.upscaleBtn=this.createButton("Upscale",!1),this.elements.downloadBtn=this.createButton("Download",!1);const p=this.createButton("‚ãØ",!1);p.style.fontSize="20px",p.style.padding=`8px ${e}`,p.style.minWidth="36px",this.elements.moreBtn=p,d.appendChild(r),d.appendChild(this.elements.upscaleBtn),d.appendChild(this.elements.downloadBtn),d.appendChild(p);const u=document.createElement("div");Object.assign(u.style,{marginTop:"8px",padding:`${e} ${t}`,borderRadius:"16px",background:a,border:"none",fontSize:"12px",color:l,display:"none",maxWidth:"280px",boxShadow:`0 4px 12px ${i}`}),this.elements.details=u;const h=document.createElement("div");h.textContent=c,h.style.marginBottom=s,this.elements.status=h;const m=document.createElement("div");m.textContent="Upscaled 0 / 0 (HD 0)",this.elements.upscaleInfo=m,u.appendChild(h),u.appendChild(m),o.appendChild(d),o.appendChild(u),document.body.appendChild(o)},attachHandlers(e){this.elements.container&&(this.elements.fetchBtn.addEventListener("click",e.fetch),this.elements.downloadBtn.addEventListener("click",e.download),this.elements.upscaleBtn.addEventListener("click",e.upscale),this.elements.moreBtn.addEventListener("click",e.toggleDetails))},showDetails(){this.ensure(),this.elements.details.style.display="block"},hideDetails(){this.ensure(),this.elements.details.style.display="none"},setStatus(e){this.ensure(),this.elements.status.textContent=e},setUpscaleInfo(e,t,s){this.ensure(),this.elements.upscaleInfo.textContent=`Upscaled ${e} / ${t} (HD ${s})`},clearLinksWrap(){this.elements.linksWrap&&(this.elements.linksWrap.remove(),this.elements.linksWrap=null)},renderMediaInfo(e){this.clearLinksWrap();const t=document.createElement("div");if(t.className="grok-media-links",t.style.marginTop=s,e.urls.length){const n=document.createElement("div"),a=e.videosToUpscale.length+e.hdVideoCount;n.textContent=`Media: ${e.urls.length} | Videos: ${a} (HD ${e.hdVideoCount}, ${e.videosToUpscale.length} to upscale)`,n.style.marginTop=s,t.appendChild(n)}else{const e=document.createElement("div");e.textContent="No media URLs detected",t.appendChild(e)}this.elements.details.appendChild(t),this.elements.linksWrap=t}},r=()=>window.location.pathname.split("/").filter(Boolean)[2]||null,p=(e,t=0)=>e.split("?")[0].split("/").filter(Boolean).pop()||`media_${t+1}`,u=e=>e&&(e.hdMediaUrl||e.mediaUrl||e.thumbnailImageUrl||null),h=(e,t)=>e+Math.random()*(t-e),m=()=>(new Date).toLocaleTimeString(),f=()=>"function"==typeof GM_download,g={lastMediaUrls:[],lastVideoIdsToUpscale:[],lastHdVideoCount:0,upscaleTotal:0,upscaleDone:0,isUpscaling:!1,upscaleRefetchTimeout:null,upscaleTimeoutIds:[],urlWatcherInterval:null,lastKnownPostId:null,resetForNewPost(e){for(this.lastMediaUrls=[],this.lastVideoIdsToUpscale=[],this.lastHdVideoCount=0,this.upscaleTotal=0,this.upscaleDone=0,this.isUpscaling=!1,this.upscaleRefetchTimeout&&(clearTimeout(this.upscaleRefetchTimeout),this.upscaleRefetchTimeout=null);this.upscaleTimeoutIds.length;){const e=this.upscaleTimeoutIds.pop();clearTimeout(e)}}},y={start(){g.urlWatcherInterval||(g.lastKnownPostId=r(),this.resetForNewPost(g.lastKnownPostId),g.urlWatcherInterval=setInterval(()=>{const e=r();e!==g.lastKnownPostId&&(g.lastKnownPostId=e,this.resetForNewPost(e))},500))},resetForNewPost(e){g.resetForNewPost(e),d.clearLinksWrap(),d.setUpscaleInfo(0,0,0),d.hideDetails(),e?d.setStatus(c):d.setStatus("Waiting for post‚Ä¶")}},w={async fetchPostData(e){const t=await fetch("/rest/media/post/get",{method:"POST",headers:{accept:"*/*","content-type":"application/json"},body:JSON.stringify({id:e})});if(!t.ok)throw new Error(`HTTP ${t.status}`);return t.json()},async upscaleVideo(e){const t=await fetch("/rest/media/video/upscale",{method:"POST",headers:{accept:"*/*","content-type":"application/json"},body:JSON.stringify({videoId:e})});if(!t.ok)throw new Error(`Upscale HTTP ${t.status}`);const s=await t.json().catch(()=>null);return console.log("[Grok Media Fetcher] Upscale response for",e,s),s}},T={processPostData(e){const t=[],s=[];let n=0;return Array.isArray(e.childPosts)&&e.childPosts.length>0&&e.childPosts.forEach(e=>{const a=u(e);a&&t.push(a),"MEDIA_POST_TYPE_VIDEO"===e.mediaType&&(e.hdMediaUrl?n+=1:e.id&&s.push(e.id))}),{urls:Array.from(new Set(t)),videosToUpscale:Array.from(new Set(s)),hdVideoCount:n}}},U={async fetchAndRender(){d.ensure();const e=r();if(e)try{const t=await w.fetchPostData(e);window.grokPostData=t,console.log("[Grok Media Fetcher] Response:",t);const s=t.post||{};d.setStatus("‚úÖ Fetched @ "+m());const n=T.processPostData(s);g.lastMediaUrls=n.urls,g.lastVideoIdsToUpscale=n.videosToUpscale,g.lastHdVideoCount=n.hdVideoCount,d.renderMediaInfo(n),g.isUpscaling||(g.upscaleTotal=n.videosToUpscale.length,g.upscaleDone=0),d.setUpscaleInfo(g.upscaleDone,g.upscaleTotal,g.lastHdVideoCount)}catch(e){console.error("[Grok Media Fetcher] Error:",e),d.setStatus("‚ùå Error (see console)")}else d.setStatus("‚ùå Could not detect post ID")},startUpscaleRefetchLoop(){if(g.upscaleRefetchTimeout)return;const e=async()=>{if(!g.isUpscaling||g.upscaleDone>=g.upscaleTotal)return void(g.upscaleRefetchTimeout=null);try{await this.fetchAndRender()}catch(e){console.error("[Grok Media Fetcher] Upscale-refetch error:",e)}const t=h(3e3,5e3);g.upscaleRefetchTimeout=setTimeout(e,t)};e()},async processUpscaleBatch(){g.isUpscaling=!0,g.upscaleTotal=g.lastVideoIdsToUpscale.length,g.upscaleDone=0,d.setUpscaleInfo(g.upscaleDone,g.upscaleTotal,g.lastHdVideoCount),d.setStatus("üöÄ Upscaling started..."),this.startUpscaleRefetchLoop(),g.upscaleTimeoutIds.splice(0,g.upscaleTimeoutIds.length);const e=[...g.lastVideoIdsToUpscale],t=e.length;let s=0;e.forEach((e,n)=>{const a=h(1e3,2e3);s+=a;const o=setTimeout(async()=>{try{await w.upscaleVideo(e),g.upscaleDone+=1,d.setUpscaleInfo(g.upscaleDone,g.upscaleTotal,g.lastHdVideoCount)}catch(t){console.error("[Grok Media Fetcher] Upscale error for",e,t)}n===t-1&&(g.isUpscaling=!1,d.setStatus("‚úÖ Upscale batch finished"))},s);g.upscaleTimeoutIds.push(o)})}},I={fallback(e,t){const s=document.createElement("a");s.href=e,s.download=t,s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s)},withGmDownload(e,t){try{GM_download({url:e,name:t,saveAs:!1,onerror:s=>{console.error("[Grok Media Fetcher] GM_download error, fallback triggered:",s),this.fallback(e,t)}})}catch(s){console.error("[Grok Media Fetcher] GM_download threw, fallback triggered:",s),this.fallback(e,t)}},trigger(e){const t=f();e.forEach((e,s)=>{setTimeout(()=>{const n=p(e,s);t?this.withGmDownload(e,n):this.fallback(e,n)},500*s)})}},k={async fetch(){await U.fetchAndRender(),d.showDetails()},async download(){d.showDetails(),d.setStatus("üîÑ Fetching latest data..."),await U.fetchAndRender(),g.lastMediaUrls&&0!==g.lastMediaUrls.length?(d.setStatus(`‚¨á Downloading ${g.lastMediaUrls.length} item(s)...`),I.trigger(g.lastMediaUrls)):d.setStatus("‚ö†Ô∏è Nothing to download ‚Äì no media found")},async upscale(){d.showDetails(),g.isUpscaling?d.setStatus("‚è≥ Already upscaling..."):(await U.fetchAndRender(),g.lastVideoIdsToUpscale&&0!==g.lastVideoIdsToUpscale.length?await U.processUpscaleBatch():d.setStatus("‚ö†Ô∏è No videos to upscale (either none or already HD)"))},toggleDetails(){d.ensure(),d.elements.details.style.display="none"===d.elements.details.style.display?"block":"none"}};function b(){d.ensure(),d.attachHandlers(k),y.start()}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",b):b()})();
})();